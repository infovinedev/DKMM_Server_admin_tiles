<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.infovine.dkmm.mapper.store.TStoreInfoMapper">
  <resultMap id="BaseResultMap" type="kr.co.infovine.dkmm.db.model.store.TStoreInfo">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 22 16:17:09 KST 2022.
    -->
    <id column="store_seq" jdbcType="BIGINT" property="storeSeq" />
    <result column="store_mngt_no" jdbcType="VARCHAR" property="storeMngtNo" />
    <result column="store_nm" jdbcType="VARCHAR" property="storeNm" />
    <result column="ctgry_nm" jdbcType="VARCHAR" property="ctgryNm" />
    <result column="road_addr" jdbcType="VARCHAR" property="roadAddr" />
    <result column="zip" jdbcType="VARCHAR" property="zip" />
    <result column="latitude" jdbcType="VARCHAR" property="latitude" />
    <result column="longitude" jdbcType="VARCHAR" property="longitude" />
    <result column="company_no" jdbcType="VARCHAR" property="companyNo" />
    <result column="store_open_time" jdbcType="VARCHAR" property="storeOpenTime" />
    <result column="store_end_time" jdbcType="VARCHAR" property="storeEndTime" />
    <result column="store_holiday_type" jdbcType="VARCHAR" property="storeHolidayType" />
    <result column="max_cnt" jdbcType="VARCHAR" property="maxCnt" />
    <result column="file_uuid" jdbcType="VARCHAR" property="fileUuid" />
    <result column="use_yn" jdbcType="VARCHAR" property="useYn" />
    <result column="del_yn" jdbcType="VARCHAR" property="delYn" />
    <result column="ins_seq" jdbcType="BIGINT" property="insSeq" />
    <result column="ins_dt" jdbcType="VARCHAR" property="insDt" />
    <result column="upt_seq" jdbcType="BIGINT" property="uptSeq" />
    <result column="upt_dt" jdbcType="VARCHAR" property="uptDt" />
    <result column="store_tel" jdbcType="VARCHAR" property="storeTel" />
    <result column="area_tot" jdbcType="VARCHAR" property="areaTot" />
    <result column="priority" jdbcType="INTEGER" property="priority" />
    <result column="like_cnt" jdbcType="BIGINT" property="likeCnt" />
    <result column="last_wait_user_seq" jdbcType="BIGINT" property="lastWaitUserSeq" />
    <result column="last_wait_person_cnt" jdbcType="INTEGER" property="lastWaitPersonCnt" />
    <result column="last_wait_ins_dt" jdbcType="TIMESTAMP" property="lastWaitInsDt" />
    <result column="old_addr" jdbcType="VARCHAR" property="oldAddr" />
    <result column="old_zip" jdbcType="VARCHAR" property="oldZip" />
  </resultMap>
  
	<sql id="searchCondition_store">
		<if test='searchStartDt != null and !"".equals(searchStartDt)'>
			AND TO_CHAR(upt_dt, 'YYYY-MM-DD') BETWEEN #{searchStartDt} AND #{searchEndDt}
		</if>
		<if test='ctgryNm != null and !"".equals(ctgryNm)'>
			AND ctgry_nm = #{ctgryNm}
		</if>
		<if test='searchText != null and !"".equals(searchText)'>
			AND store_nm LIKE CONCAT('%', #{searchText}, '%')
		</if>
	</sql>
	
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 22 16:17:09 KST 2022.
    -->
    delete from t_store_info
    where store_seq = #{storeSeq,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="kr.co.infovine.dkmm.db.model.store.TStoreInfo">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 22 16:17:09 KST 2022.
    -->
    insert into t_store_info (store_seq, store_mngt_no, store_nm, 
      ctgry_nm, road_addr, zip, 
      latitude, longitude, company_no, 
      store_open_time, store_end_time, store_holiday_type, 
      max_cnt, file_uuid, use_yn, 
      del_yn, ins_seq, ins_dt, 
      upt_seq, upt_dt, store_tel, 
      area_tot, priority, like_cnt, 
      last_wait_user_seq, last_wait_person_cnt, last_wait_ins_dt, 
      old_addr, old_zip)
    values (#{storeSeq,jdbcType=BIGINT}, #{storeMngtNo,jdbcType=VARCHAR}, #{storeNm,jdbcType=VARCHAR}, 
      #{ctgryNm,jdbcType=VARCHAR}, #{roadAddr,jdbcType=VARCHAR}, #{zip,jdbcType=VARCHAR}, 
      #{latitude,jdbcType=VARCHAR}, #{longitude,jdbcType=VARCHAR}, #{companyNo,jdbcType=VARCHAR}, 
      #{storeOpenTime,jdbcType=VARCHAR}, #{storeEndTime,jdbcType=VARCHAR}, #{storeHolidayType,jdbcType=VARCHAR}, 
      #{maxCnt,jdbcType=VARCHAR}, #{fileUuid,jdbcType=VARCHAR}, #{useYn,jdbcType=VARCHAR}, 
      #{delYn,jdbcType=VARCHAR}, #{insSeq,jdbcType=BIGINT}, #{insDt,jdbcType=TIMESTAMP}, 
      #{uptSeq,jdbcType=BIGINT}, #{uptDt,jdbcType=TIMESTAMP}, #{storeTel,jdbcType=VARCHAR}, 
      #{areaTot,jdbcType=VARCHAR}, #{priority,jdbcType=INTEGER}, #{likeCnt,jdbcType=BIGINT}, 
      #{lastWaitUserSeq,jdbcType=BIGINT}, #{lastWaitPersonCnt,jdbcType=INTEGER}, #{lastWaitInsDt,jdbcType=TIMESTAMP}, 
      #{oldAddr,jdbcType=VARCHAR}, #{oldZip,jdbcType=VARCHAR})
  </insert>
  <update id="updateByPrimaryKey" parameterType="kr.co.infovine.dkmm.db.model.store.TStoreInfo">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 22 16:17:09 KST 2022.
    -->
    update t_store_info
    set store_mngt_no = #{storeMngtNo,jdbcType=VARCHAR},
      store_nm = #{storeNm,jdbcType=VARCHAR},
      ctgry_nm = #{ctgryNm,jdbcType=VARCHAR},
      road_addr = #{roadAddr,jdbcType=VARCHAR},
      zip = #{zip,jdbcType=VARCHAR},
      latitude = #{latitude,jdbcType=VARCHAR},
      longitude = #{longitude,jdbcType=VARCHAR},
      company_no = #{companyNo,jdbcType=VARCHAR},
      store_open_time = #{storeOpenTime,jdbcType=VARCHAR},
      store_end_time = #{storeEndTime,jdbcType=VARCHAR},
      store_holiday_type = #{storeHolidayType,jdbcType=VARCHAR},
      max_cnt = #{maxCnt,jdbcType=VARCHAR},
      file_uuid = #{fileUuid,jdbcType=VARCHAR},
      use_yn = #{useYn,jdbcType=VARCHAR},
      del_yn = #{delYn,jdbcType=VARCHAR},
      ins_seq = #{insSeq,jdbcType=BIGINT},
      ins_dt = #{insDt,jdbcType=TIMESTAMP},
      upt_seq = #{uptSeq,jdbcType=BIGINT},
      upt_dt = #{uptDt,jdbcType=TIMESTAMP},
      store_tel = #{storeTel,jdbcType=VARCHAR},
      area_tot = #{areaTot,jdbcType=VARCHAR},
      priority = #{priority,jdbcType=INTEGER},
      like_cnt = #{likeCnt,jdbcType=BIGINT},
      last_wait_user_seq = #{lastWaitUserSeq,jdbcType=BIGINT},
      last_wait_person_cnt = #{lastWaitPersonCnt,jdbcType=INTEGER},
      last_wait_ins_dt = #{lastWaitInsDt,jdbcType=TIMESTAMP},
      old_addr = #{oldAddr,jdbcType=VARCHAR},
      old_zip = #{oldZip,jdbcType=VARCHAR}
    where store_seq = #{storeSeq,jdbcType=BIGINT}
  </update>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 22 16:17:09 KST 2022.
    -->
    select store_seq, store_mngt_no, store_nm, ctgry_nm, road_addr, zip, latitude, longitude, 
    company_no, store_open_time, store_end_time, store_holiday_type, max_cnt, file_uuid, 
    use_yn, del_yn, ins_seq, ins_dt, upt_seq, upt_dt, store_tel, area_tot, priority, 
    like_cnt, last_wait_user_seq, last_wait_person_cnt, last_wait_ins_dt, old_addr, old_zip
    from t_store_info
    where store_seq = #{storeSeq,jdbcType=BIGINT}
  </select>
  <select id="selectAll" parameterType="kr.co.infovine.dkmm.db.model.store.TStoreInfo" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 22 16:17:09 KST 2022.
    -->
    select store_seq, store_mngt_no, store_nm, ctgry_nm, road_addr, zip, latitude, longitude, 
    company_no, store_open_time, store_end_time, store_holiday_type, max_cnt, file_uuid, 
    use_yn, del_yn, ins_seq, ins_dt, upt_seq, upt_dt, store_tel, area_tot, priority, 
    like_cnt, last_wait_user_seq, last_wait_person_cnt, last_wait_ins_dt, old_addr, old_zip
    from t_store_info
  </select>
  
  <select id="selectStoreInfo" parameterType="kr.co.infovine.dkmm.db.model.store.TStoreInfo" resultMap="BaseResultMap">
	/* 상점 목록 조회 selectStoreInfo */
	select SUB.*
			from (
				SELECT a.store_seq
					 , a.store_nm
					 , a.ctgry_nm
					 , a.road_addr
					 , a.del_yn
					 , a.like_cnt
					 ,a.file_uuid
					 ,a.last_wait_user_seq
					 ,a.last_wait_person_cnt
					 ,TO_CHAR(a.last_wait_ins_dt, 'YYYY-MM-DD HH:MI') as last_wait_ins_dt
			FROM t_store_info a
		 WHERE 1 = 1
		   AND use_yn = 'Y'
		   AND del_yn = 'N'
		<include refid="searchCondition_store"></include>
		 ORDER BY a.store_seq DESC
		) SUB
	</select>
  
  	<select id="selectDetail" parameterType="kr.co.infovine.dkmm.db.model.store.TStoreInfo" resultMap="BaseResultMap">
	/* 상점 상세목록 조회 selectDetail */
				SELECT store_seq
					 , store_nm
					 , ctgry_nm
					 , road_addr
					 , del_yn
					 , like_cnt
					 , file_uuid
					 , area_tot
					 , max_cnt
					 , last_wait_user_seq
					 , last_wait_person_cnt
					 , zip
					 , latitude
					 , longitude
					 , store_open_time
					 , store_end_time
					 , TO_CHAR(ins_dt, 'YYYY-MM-DD HH:MI') as ins_dt
					 , TO_CHAR(last_wait_ins_dt, 'YYYY-MM-DD HH:MI') as last_wait_ins_dt
			FROM t_store_info
		 WHERE 1 = 1
		   AND store_seq = #{storeSeq}
  </select>
  
  <insert id="insertStoreInfo" parameterType="kr.co.infovine.dkmm.db.model.store.TStoreInfo">
	/* 상점 저장하기 insertStoreInfo */
		INSERT INTO t_store_info
		  (  
		      store_sql
		    , store_nm
		    , ctgry_nm
		    , road_addr
		    , zip
		    , company_no
		    , store_open_time
		    , store_end_time
		    , store_holiday_type
		    , max_cnt
		    , ins_seq
		    , ins_dt
		    , upt_seq
		    , upt_dt
		    , latitude
		    , longitude
		    , area_tot
		    , store_tel
		  )
		VALUES
		  (
		     (select max(store_seq) + 1  from t_store_info)
		    , #{storeNm,jdbcType=VARCHAR}
		    , #{ctgryNm,jdbcType=VARCHAR}
		    , #{roadAddr,jdbcType=VARCHAR}
		    , #{zip,jdbcType=VARCHAR}
		    , #{companyNo,jdbcType=VARCHAR}
		    , #{storeOpenTime,jdbcType=VARCHAR}
		    , #{storeEndTime,jdbcType=VARCHAR}
		    , #{storeHolidayType,jdbcType=VARCHAR}
		    , #{maxCnt,jdbcType=VARCHAR}
		    , 0 <!-- #{insSeq,jdbcType=INTEGER} -->
		    , NOW()
		    , 0 <!-- #{uptSeq,jdbcType=INTEGER} -->
		    , NOW()
		    , #{latitude,jdbcType=VARCHAR}
		    , #{longitude,jdbcType=VARCHAR}
		    , #{areaTot,jdbcType=VARCHAR}
		    , #{storeTel,jdbcType=VARCHAR}
		  )
	</insert>
	
	<insert id="mergeStoreInfo" >
  	/* TStoreInfo.mergeStoreInfo   STORE_INFO 정보 update */
  	INSERT INTO t_store_info				
	(                                       
    	 store_mngt_no                      
		,store_nm                           
		,ctgry_nm                           
		,road_addr                          
		,zip                                
		,old_addr                           
		,old_zip                            
		,ins_seq                            
		,upt_seq                            
		,store_tel                          
		,area_tot                           
	)                                       
	SELECT                                  
		manage_no as store_mngt_no          
		,store_nm as store_nm               
		,ctgry_nm as ctgry_nm               
		,road_addr as road_addr             
		,road_zip as zip                    
		,road_addr as old_addr              
		,road_zip as old_zip                
		,0 as ins_seq                       
		,0 as upt_seq                       
		,tel as store_tel                   
		,area_tot                           
	FROM t_store_info_org                   
	WHERE status_type = '01'                
	AND   process_yn = 'N'                  
	ON CONFLICT (store_mngt_no) DO UPDATE   
    SET                                     
    	road_addr = excluded.road_addr      
    	,zip = excluded.zip                 
    	,store_tel = excluded.store_tel     
    	,old_addr = excluded.old_addr       
    	,old_zip = excluded.old_zip  
    	,area_tot = excluded.area_tot   
    	,latitude = (CASE WHEN t_store_info.road_addr = excluded.road_addr THEN t_store_info.latitude ELSE NULL END)
    	,longitude = (CASE WHEN t_store_info.road_addr = excluded.road_addr THEN t_store_info.longitude ELSE NULL END) 
  </insert>
  
  <update id="updateCloseStoreInfo">
  	/* TStoreInfo.updateCloseStoreInfo   STORE_INFO 폐업 상점 update */
  	<![CDATA[
	UPDATE 	t_store_info	A			
	SET		use_yn = 'N'					
			,del_yn = 'Y'					
	FROM	t_store_info_org B				
	WHERE A.store_mngt_no = B.manage_no  
	AND   B.process_yn = 'N'             
	AND   B.status_type <> '01'     
	]]>     
  </update>
</mapper>