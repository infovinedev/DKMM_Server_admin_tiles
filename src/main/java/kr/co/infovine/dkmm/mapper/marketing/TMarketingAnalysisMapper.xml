<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.infovine.dkmm.mapper.marketing.TMarketingAnalysisMapper">
  <resultMap id="BaseResultMap" type="kr.co.infovine.dkmm.db.model.marketing.TMarketingAnalysis">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 12 16:19:04 KST 2022.
    -->
    <id column="marketing_seq" jdbcType="INTEGER" property="marketingSeq" />
    <result column="channel" jdbcType="VARCHAR" property="channel" />
    <result column="week_type" jdbcType="VARCHAR" property="weekType" />
    <result column="os_type" jdbcType="VARCHAR" property="osType" />
    <result column="os_type_aos" jdbcType="VARCHAR" property="osTypeAos" />
    <result column="os_type_ios" jdbcType="VARCHAR" property="osTypeIos" />
    <result column="move_store_cnt" jdbcType="INTEGER" property="moveStoreCnt" />
    <result column="down_cnt" jdbcType="INTEGER" property="downCnt" />
    <result column="click_cnt" jdbcType="INTEGER" property="clickCnt" />
    <result column="regit_cnt" jdbcType="INTEGER" property="regitCnt" />
    <result column="week_cnt" jdbcType="INTEGER" property="weekCnt" />
    <result column="ins_dt" jdbcType="VARCHAR" property="insDt" />
    <!-- 추가 -->
    <result column="click_cnt_aos" jdbcType="INTEGER" property="clickCntAos" />
    <result column="click_cnt_ios" jdbcType="INTEGER" property="clickCntIos" />
    <result column="move_store_cnt_aos" jdbcType="INTEGER" property="moveStoreCntAos" />
    <result column="move_store_cnt_ios" jdbcType="INTEGER" property="moveStoreCntIos" />
    <result column="down_cnt_aos" jdbcType="INTEGER" property="downCntAos" />
    <result column="down_cnt_ios" jdbcType="INTEGER" property="downCntIos" />
    <result column="regit_cnt_aos" jdbcType="INTEGER" property="regitCntAos" />
    <result column="regit_cnt_ios" jdbcType="INTEGER" property="regitCntIos" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 12 16:19:04 KST 2022.
    -->
    delete from t_marketing_analysis
    where marketing_seq = #{marketingSeq,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="kr.co.infovine.dkmm.db.model.marketing.TMarketingAnalysis">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 12 16:19:04 KST 2022.
    -->
    insert into t_marketing_analysis (marketing_seq, channel, week_type, 
      os_type, move_store_cnt, down_cnt, 
      regit_cnt, ins_dt)
    values (#{marketingSeq,jdbcType=INTEGER}, #{channel,jdbcType=VARCHAR}, #{weekType,jdbcType=VARCHAR}, 
      #{osType,jdbcType=VARCHAR}, #{moveStoreCnt,jdbcType=INTEGER}, #{downCnt,jdbcType=INTEGER}, 
      #{regitCnt,jdbcType=INTEGER}, #{insDt,jdbcType=TIMESTAMP})
  </insert>
  <update id="updateByPrimaryKey" parameterType="kr.co.infovine.dkmm.db.model.marketing.TMarketingAnalysis">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 12 16:19:04 KST 2022.
    -->
    update t_marketing_analysis
    set channel = #{channel,jdbcType=VARCHAR},
      week_type = #{weekType,jdbcType=VARCHAR},
      os_type = #{osType,jdbcType=VARCHAR},
      move_store_cnt = #{moveStoreCnt,jdbcType=INTEGER},
      down_cnt = #{downCnt,jdbcType=INTEGER},
      regit_cnt = #{regitCnt,jdbcType=INTEGER},
      ins_dt = #{insDt,jdbcType=TIMESTAMP}
    where marketing_seq = #{marketingSeq,jdbcType=INTEGER}
  </update>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 12 16:19:04 KST 2022.
    -->
    select marketing_seq, channel, week_type, os_type, move_store_cnt, down_cnt, regit_cnt, 
    ins_dt
    from t_marketing_analysis
    where marketing_seq = #{marketingSeq,jdbcType=INTEGER}
  </select>
  <select id="selectAll" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 12 16:19:04 KST 2022.
    -->
    select marketing_seq, channel, week_type, os_type, move_store_cnt, down_cnt, regit_cnt, 
    ins_dt
    from t_marketing_analysis
  </select>
  
  <select id="marketingMonthly" resultMap="BaseResultMap">
   SELECT
        count(marketing_seq) as click_cnt
        ,count(case when os_type='AOS' then marketing_seq end) as click_cnt_aos
        ,count(case when os_type='IOS' then marketing_seq end) as click_cnt_ios
        ,sum(move_store_cnt) as move_store_cnt
        ,sum(case when os_type='AOS' then move_store_cnt end) as move_store_cnt_aos
        ,sum(case when os_type='IOS' then move_store_cnt end) as move_store_cnt_ios
        ,sum(down_cnt) as down_cnt
        ,sum(case when os_type='AOS' then down_cnt end) as down_cnt_aos
        ,sum(case when os_type='IOS' then down_cnt end) as down_cnt_ios
        ,sum(regit_cnt) as regit_cnt
        ,sum(case when os_type='AOS' then  regit_cnt end) as regit_cnt_aos
        ,sum(case when os_type='IOS' then  regit_cnt end) as regit_cnt_ios
        ,TO_CHAR(now(), 'YYYYMM') as ins_dt
     FROM t_marketing_analysis
        where 1=1
  </select>
  
  <select id="marketingWeekly" resultMap="BaseResultMap">
  /* 메인 사용자 등록 막대챠트 getAnalysisChart2 */
        select
             t.regit_cnt
            ,EXTRACT(DOW FROM t.ins_dt::date ) as week_cnt
            ,t.ins_dt
            ,t.os_type_aos
            ,t.os_type_ios
            ,(
                    case when EXTRACT(DOW FROM t.ins_dt::date ) = 0 then '일'
                    when EXTRACT(DOW FROM t.ins_dt::date ) = 1 then '월'
                    when EXTRACT(DOW FROM t.ins_dt::date ) = 2 then '화'
                    when EXTRACT(DOW FROM t.ins_dt::date ) = 3 then '수'
                    when EXTRACT(DOW FROM t.ins_dt::date ) = 4 then '목'
                    when EXTRACT(DOW FROM t.ins_dt::date ) = 5 then '금'
                    when EXTRACT(DOW FROM t.ins_dt::date ) = 6 then '토'
                    end
                ) as week_type                
        from (
             select
                 count(user_seq) as regit_cnt
                ,TO_CHAR(ins_dt, 'YYYYMMDD') as ins_dt
                ,count(case when os_type='AOS' then os_type end) as os_type_aos
                ,count(case when os_type='IOS' then os_type end) as os_type_ios
            from t_user_info
            where 1=1
            <![CDATA[
                and (date_trunc('week', now())+ '-1 days'::interval)::date < ins_dt
                and  ins_dt <  (date_trunc('week', now())+ '7 days'::interval)::date
             ]]>
            group by TO_CHAR(ins_dt, 'YYYYMMDD')
            order by ins_dt asc
            ) t
  </select>
  
</mapper>