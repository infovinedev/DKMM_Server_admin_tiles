<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.infovine.dkmm.mapper.user.TUserInfoMapper">
  <resultMap id="BaseResultMap" type="kr.co.infovine.dkmm.db.model.user.TUserInfo">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 22 17:05:02 KST 2022.
    -->
    <id column="user_seq" jdbcType="INTEGER" property="userSeq" />
    <result column="user_id" jdbcType="VARCHAR" property="userId" />
    <result column="user_type" jdbcType="VARCHAR" property="userType" />
    <result column="user_pw" jdbcType="VARCHAR" property="userPw" />
    <result column="user_name" jdbcType="VARCHAR" property="userName" />
    <result column="nick_name" jdbcType="VARCHAR" property="nickName" />
    <result column="gender" jdbcType="VARCHAR" property="gender" />
    <result column="email" jdbcType="VARCHAR" property="email" />
    <result column="phone" jdbcType="VARCHAR" property="phone" />
    <result column="tel" jdbcType="VARCHAR" property="tel" />
    <result column="birth" jdbcType="VARCHAR" property="birth" />
    <result column="addr" jdbcType="VARCHAR" property="addr" />
    <result column="addr_detail" jdbcType="VARCHAR" property="addrDetail" />
    <result column="zip" jdbcType="VARCHAR" property="zip" />
    <result column="meno" jdbcType="VARCHAR" property="meno" />
    <result column="user_photo" jdbcType="VARCHAR" property="userPhoto" />
    <result column="last_time" jdbcType="TIMESTAMP" property="lastTime" />
    <result column="last_ip" jdbcType="VARCHAR" property="lastIp" />
    <result column="approval_yn" jdbcType="VARCHAR" property="approvalYn" />
    <result column="use_yn" jdbcType="VARCHAR" property="useYn" />
    <result column="del_yn" jdbcType="VARCHAR" property="delYn" />
    <result column="ins_seq" jdbcType="BIGINT" property="insSeq" />
    <result column="ins_dt" jdbcType="VARCHAR" property="insDt" />
    <result column="ins_ip" jdbcType="VARCHAR" property="insIp" />
    <result column="upt_seq" jdbcType="BIGINT" property="uptSeq" />
    <result column="upt_dt" jdbcType="TIMESTAMP" property="uptDt" />
    <result column="upt_ip" jdbcType="VARCHAR" property="uptIp" />
    <result column="access_token" jdbcType="VARCHAR" property="accessToken" />
    <result column="refresh_token" jdbcType="VARCHAR" property="refreshToken" />
    <result column="nick_seq" jdbcType="BIGINT" property="nickSeq" />
    <result column="di" jdbcType="VARCHAR" property="di" />
    <result column="ci" jdbcType="VARCHAR" property="ci" />
    <result column="tel_type" jdbcType="VARCHAR" property="telType" />
    <result column="person_type" jdbcType="VARCHAR" property="personType" />
    <result column="approval_dt" jdbcType="DATE" property="approvalDt" />
    <result column="market_yn" jdbcType="VARCHAR" property="marketYn" />
    <result column="os_type" jdbcType="VARCHAR" property="osType" />
    <result column="push_token" jdbcType="VARCHAR" property="pushToken" />
    <result column="sms_yn" jdbcType="VARCHAR" property="smsYn" />
    <result column="inflow_channel" jdbcType="VARCHAR" property="inflowChannel" />
    <result column="point" jdbcType="VARCHAR" property="point" />
    <result column="like_cnt" jdbcType="VARCHAR" property="likeCnt" />
  </resultMap>
  
	<sql id="searchCondition_user">
		<if test='searchStartDt != null and !"".equals(searchStartDt)'>
			AND TO_CHAR(upt_dt, 'YYYY-MM-DD') BETWEEN #{searchStartDt} AND #{searchEndDt}
		</if>
		<if test='osType neq null and !"".equals(osType)'>
			AND os_type = #{osType}
		</if>
		<if test='searchText != null and !"".equals(searchText)'>
			 AND (nick_name LIKE CONCAT('%', #{searchText}, '%') OR phone LIKE CONCAT('%', #{searchText}, '%'))
		</if>
	</sql>
	
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 22 17:05:02 KST 2022.
    -->
    delete from t_user_info
    where user_seq = #{userSeq,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="kr.co.infovine.dkmm.db.model.user.TUserInfo">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 22 17:05:02 KST 2022.
    -->
    insert into t_user_info (user_seq, user_id, user_type, 
      user_pw, user_name, nick_name, 
      gender, email, phone, 
      tel, birth, addr, addr_detail, 
      zip, meno, user_photo, 
      last_time, last_ip, approval_yn, 
      use_yn, del_yn, ins_seq, 
      ins_dt, ins_ip, upt_seq, 
      upt_dt, upt_ip, access_token, 
      refresh_token, nick_seq, di, 
      ci, tel_type, person_type, 
      approval_dt, market_yn, os_type, 
      push_token, sms_yn, inflow_channel
      )
    values (#{userSeq,jdbcType=INTEGER}, #{userId,jdbcType=VARCHAR}, #{userType,jdbcType=VARCHAR}, 
      #{userPw,jdbcType=VARCHAR}, #{userName,jdbcType=VARCHAR}, #{nickName,jdbcType=VARCHAR}, 
      #{gender,jdbcType=VARCHAR}, #{email,jdbcType=VARCHAR}, #{phone,jdbcType=VARCHAR}, 
      #{tel,jdbcType=VARCHAR}, #{birth,jdbcType=VARCHAR}, #{addr,jdbcType=VARCHAR}, #{addrDetail,jdbcType=VARCHAR}, 
      #{zip,jdbcType=VARCHAR}, #{meno,jdbcType=VARCHAR}, #{userPhoto,jdbcType=VARCHAR}, 
      #{lastTime,jdbcType=TIMESTAMP}, #{lastIp,jdbcType=VARCHAR}, #{approvalYn,jdbcType=VARCHAR}, 
      #{useYn,jdbcType=VARCHAR}, #{delYn,jdbcType=VARCHAR}, #{insSeq,jdbcType=BIGINT}, 
      #{insDt,jdbcType=TIMESTAMP}, #{insIp,jdbcType=VARCHAR}, #{uptSeq,jdbcType=BIGINT}, 
      #{uptDt,jdbcType=TIMESTAMP}, #{uptIp,jdbcType=VARCHAR}, #{accessToken,jdbcType=VARCHAR}, 
      #{refreshToken,jdbcType=VARCHAR}, #{nickSeq,jdbcType=BIGINT}, #{di,jdbcType=VARCHAR}, 
      #{ci,jdbcType=VARCHAR}, #{telType,jdbcType=VARCHAR}, #{personType,jdbcType=VARCHAR}, 
      #{approvalDt,jdbcType=DATE}, #{marketYn,jdbcType=VARCHAR}, #{osType,jdbcType=VARCHAR}, 
      #{pushToken,jdbcType=VARCHAR}, #{smsYn,jdbcType=VARCHAR}, #{inflowChannel,jdbcType=VARCHAR}
      )
  </insert>
  <update id="updateByPrimaryKey" parameterType="kr.co.infovine.dkmm.db.model.user.TUserInfo">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 22 17:05:02 KST 2022.
    -->
    update t_user_info
    set user_id = #{userId,jdbcType=VARCHAR},
      user_type = #{userType,jdbcType=VARCHAR},
      user_pw = #{userPw,jdbcType=VARCHAR},
      user_name = #{userName,jdbcType=VARCHAR},
      nick_name = #{nickName,jdbcType=VARCHAR},
      gender = #{gender,jdbcType=VARCHAR},
      email = #{email,jdbcType=VARCHAR},
      phone = #{phone,jdbcType=VARCHAR},
      tel = #{tel,jdbcType=VARCHAR},
      birth = #{birth,jdbcType=VARCHAR},
      addr = #{addr,jdbcType=VARCHAR},
      addr_detail = #{addrDetail,jdbcType=VARCHAR},
      zip = #{zip,jdbcType=VARCHAR},
      meno = #{meno,jdbcType=VARCHAR},
      user_photo = #{userPhoto,jdbcType=VARCHAR},
      last_time = #{lastTime,jdbcType=TIMESTAMP},
      last_ip = #{lastIp,jdbcType=VARCHAR},
      approval_yn = #{approvalYn,jdbcType=VARCHAR},
      use_yn = #{useYn,jdbcType=VARCHAR},
      del_yn = #{delYn,jdbcType=VARCHAR},
      ins_seq = #{insSeq,jdbcType=BIGINT},
      ins_dt = #{insDt,jdbcType=TIMESTAMP},
      ins_ip = #{insIp,jdbcType=VARCHAR},
      upt_seq = #{uptSeq,jdbcType=BIGINT},
      upt_dt = #{uptDt,jdbcType=TIMESTAMP},
      upt_ip = #{uptIp,jdbcType=VARCHAR},
      access_token = #{accessToken,jdbcType=VARCHAR},
      refresh_token = #{refreshToken,jdbcType=VARCHAR},
      nick_seq = #{nickSeq,jdbcType=BIGINT},
      di = #{di,jdbcType=VARCHAR},
      ci = #{ci,jdbcType=VARCHAR},
      tel_type = #{telType,jdbcType=VARCHAR},
      person_type = #{personType,jdbcType=VARCHAR},
      approval_dt = #{approvalDt,jdbcType=DATE},
      market_yn = #{marketYn,jdbcType=VARCHAR},
      os_type = #{osType,jdbcType=VARCHAR},
      push_token = #{pushToken,jdbcType=VARCHAR},
      sms_yn = #{smsYn,jdbcType=VARCHAR},
      inflow_channel = #{inflowChannel,jdbcType=VARCHAR}
    where user_seq = #{userSeq,jdbcType=INTEGER}
  </update>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 22 17:05:02 KST 2022.
    -->
    select user_seq, user_id, user_type, user_pw, user_name, nick_name, gender, email, 
    phone, tel, birth, addr, addr_detail, zip, meno, user_photo, last_time, last_ip, 
    approval_yn, use_yn, del_yn, ins_seq, ins_dt, ins_ip, upt_seq, upt_dt, upt_ip, access_token, 
    refresh_token, nick_seq, di, ci, tel_type, person_type, approval_dt, market_yn, os_type, 
    push_token, sms_yn, inflow_channel
    from t_user_info
    where user_seq = #{userSeq,jdbcType=INTEGER}
  </select>
  <select id="selectAll" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Nov 22 17:05:02 KST 2022.
    -->
    select user_seq, user_id, user_type, user_pw, user_name, nick_name, gender, email, 
    phone, tel, birth, addr, addr_detail, zip, meno, user_photo, last_time, last_ip, 
    approval_yn, use_yn, del_yn, ins_seq, ins_dt, ins_ip, upt_seq, upt_dt, upt_ip, access_token, 
    refresh_token, nick_seq, di, ci, tel_type, person_type, approval_dt, market_yn, os_type, 
    push_token, sms_yn, inflow_channel
    from t_user_info
  </select>
  
  <select id="selectUserInfo" parameterType="kr.co.infovine.dkmm.db.model.user.TUserInfo" resultMap="JoinResultMap">
	/* 회원정보 조회 selectUserInfo */
		SELECT
			ROW_NUMBER() OVER() AS rowNum
			,a.user_seq
			,a.nick_name
			,(CASE
				  WHEN a.gender = 'M' THEN '남'
				  WHEN a.gender = 'F' THEN '여'
				  ELSE '-'
				END
			) AS gender
			,TO_CHAR(a.ins_dt, 'YYYY-MM-DD HH:MI') as ins_dt
			,coalesce((SELECT sum(point) FROM t_user_work WHERE user_seq = a.user_seq ), 0) as point
			,a.os_type
		FROM t_user_info a
		WHERE 1=1
		AND a.del_yn = 'N'
		<include refid="searchCondition_user"></include>
		ORDER BY a.user_seq DESC
	</select>
	
	<resultMap id="JoinResultMap" type="kr.co.infovine.dkmm.db.model.user.TUserInfo" extends="BaseResultMap">
		<id column="user_seq" jdbcType="VARCHAR" property="userSeq" />
		<association property="waitCnt" column="{userSeq=user_seq}" select="kr.co.infovine.dkmm.mapper.user.TUserInfoMapper.selectWaitCnt"/>
	</resultMap>
	
	<select id="selectWaitCnt" parameterType="kr.co.infovine.dkmm.db.model.user.TUserInfo" resultMap="BaseResultMap">
	/* 회원정보 조회 selectWaitCnt  association_test*/
		SELECT COUNT(*) FROM t_store_wait WHERE DEL_YN = 'N' AND user_seq = #{userSeq}
	</select>
	
	<select id="selectDetail" parameterType="kr.co.infovine.dkmm.db.model.user.TUserInfo" resultMap="BaseResultMap">
	/* 회원정보 상세조회 selectDetail */
		SELECT
			 a.user_seq
			,a.user_id
			,a.user_type
			,a.nick_name
			,(CASE
			   WHEN a.gender = 'M' THEN '남'
			   WHEN a.gender = 'F' THEN '여'
			   ELSE '-'
			  END
			) AS gender
			,CONCAT(substring(fn_decrypt(a.phone) from 1 for 3),'-' ,substring(fn_decrypt(a.phone) from 4 for 4), '-' ,substring(fn_decrypt(a.phone) from 8 for 4)) as phone
			,COALESCE(fn_decrypt(a.email) , '-') as email
			,a.birth
			,EXTRACT(year from age(a.birth::date))+1 as age
			,coalesce((SELECT sum(point) FROM t_user_work WHERE user_seq = a.user_seq ), 0) as point
			,(SELECT count(*) FROM t_user_work WHERE user_seq = a.user_seq ) as coupon
			,'-' as category
			,TO_CHAR(a.ins_dt, 'YYYY-MM-DD HH:MI') as ins_dt
			,(SELECT COUNT(*) FROM t_store_wait WHERE DEL_YN = 'N' AND user_seq = a.user_seq) as wait_cnt
			,(SELECT COUNT(*) FROM t_store_like WHERE DEL_YN = 'N' AND user_seq =a.user_seq) as like_cnt
			,(CASE
			   WHEN a.ci is not null THEN 'Y'
			   ELSE 'N'
			  END
			) as use_yn
			,a.os_type
            ,a.ci
		FROM t_user_info a
		WHERE a.user_seq = ${userSeq}
	</select>
</mapper>